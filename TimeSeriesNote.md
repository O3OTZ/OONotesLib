# 时间序列

## 时间序列含义

> 时间序列是按照时间获得的一个观察值序列$\left\{ {{z_t},t \in T} \right\}$，该序列的一个特征就是观察值之间的相关性。
> 时间序列分析方法所讨论的就是对这种相关性的分析，根据通过对观察值序列的$\left\{ {{z_t},t \in T} \right\}$的分析，揭示其性质，建立随机过程模型（统计模型），并将模型应用各种应用领域，例如预测。
>
> ​								——基于模型预测方法的空调系统优化控制策略研究

## 时间序列的分解

任何时间序列可以被拆分为3个部分：

1. 趋势：趋势是比较明显的，比如极速的上升或迅速下跌
2. 季节性：可以在数据中看到明显的周期性，并且这个周期性和时间周期有关。这个周期可能是月、季度或年。
3. 误差项

但不是说所有的时间序列都必须具备这3个部分。时间序列可能没有明显的趋势、可能没有明显的周期性，或者两个都没有。

## 短期、中期和长期预测

1. 根据预测时间范围，预测可分为三类[1]：
   短期：小于一周
   中期：一周到一年
   长期：一年以上
2. 根据实际建筑方案的不同需求，有两种常见预测方案[2]：
   短期负荷预测：short-term load forecasting，STLF，几秒钟到未来两周
   长期负荷预测：long-term load forecasting，LTLF，几个月或更长时间

[1]Energy prediction techniques for large-scale buildings towards a sustainable built environment: A review
[2]Physical energy and data-driven models in building energy prediction: A review

## 基于传统模型的时间序列预测

### 基于统计模型的时间序列预测概述

#### 时间序列预测含义

**时间序列预测**是根据数据过去一段时间的状态，在满足**趋势一致**以及**不发生跳变**的前提下，预测未来一段时间的数据情况。

#### 常用方式

##### 时间序列预测方式分类（基于统计学原理）

​	（1）日常周期预测
​				[1]同环比——计算方式：预测值=上周周期值×近期权重
​				[2]自回归系列（AR、ARIMA等）——计算方式：通过确定参数，如p、d、q，预测未来趋势。
​				[3]三次指数平滑（Holt-Winters）——计算方式：累加模型/累乘模型
​				[4]prophet——计算方式：趋势、周期性、突变点、噪声项共同拟合
​	（2）节假日特殊周期预测
​				[1]同环比
​				[2]prophet

##### 方式特点

###### [自回归系列]方式弊端

1. 仅适用于短期预测，对于中长期表现不佳
2. 无法处理由于节假日、特殊时点（例如：双十一）等带来的变点问题（即时间序列的突变点预测）
3. 模型的解耦能力较差，无法分析出影响准确率的潜在因素

###### Prophet适用场景

预测模型均有其适用的场景，只有在合适的场景下，才能发挥模型本身的威力，具体适用场景如下：

1. 训练数据：拥有至少一个完整周期的数据，让模型完整学习规律。
2. 数据趋势：数据有一定正常的周期效应，例如：周末效应、季节效应等。
3. 跳变情况：明确可能发生跳变的时间点及窗口期，例如：双十一、国庆节等。
4. 缺失值符合预期：历史数据的缺失值和异常值保持在合理范围内。

###### Prophet原理

Prophet可将趋势项、周期项、节假日项解耦开来，因此该模型也是由这三者，加上噪声项组合而成，如下图：
![prophet原理](E:\Python&Algorithm\Dat&AlgorithmNote_image\prophet原理.png)

- g(t)：趋势项。用于拟合时间序列非周期性的趋势变化。例如：上升、下降趋势；
- s(t)：周期项。用于拟合周、月、季的周期性变化趋势；
- h(t)：节假日项。用于表示潜在的跳变点对预测的影响。例如：节假日、突变事件等；
- ε(t)：噪音项。用于表示未预测到的随机波动。

总体来讲，Prophet是通过四个组件模型自加形成整体模型，并采用Stan的L-BFGS来进行模型拟合。【L-BFGS类似SGD（随机梯度下降），但大多数情况下收敛更快。】

### 时间序列预测常用方式详解

#### 一、描述性时序分析

1、含义：通过数据比较或绘图观测，寻找序列中蕴含的发展规律的一种分析方法。
2、二十四节气为其的一种应用结果，揭示了天文气象变化的规律。

#### 二、统计时序分析

含义：利用数理统计学原理分析时间序列，更准确地估计随机序列发展变化的规律，分析序列值内在的相关关系。

##### 频域分析方法

##### 时域分析方法

###### 1、平稳时间序列分析

1. **自回归模型AR**
   $$
   {x_t} = {\phi _0} + {\phi _1}{x_{t - 1}} + {\phi _2}{x_{t - 2}} +  \cdots  + {\phi _p}{x_{t - p}} + {\varepsilon _t}
   $$
   （1）含义是当前时间点的值等于过去若干个时间点的值的回归——因为不依赖于别的解释变量，只依赖于自己过去的历史值，故称为自回归。
   （2）如果依赖过去最近的p个历史值，称阶数为p，记为==AR(p)==模型。

2. **滑动平均模型MA**
   $$
   {x_t} = \mu  + {\varepsilon _t} - {\phi _1}{\varepsilon _{t - 1}} - {\phi _2}{\varepsilon _{t - 2}} -  \cdots  - {\phi _q}{\varepsilon _{t - q}}
   $$
   （1）含义是当前时间点的值等于过去若干时间点的预测误差的回归（预测误差=模型预测值-真实值）。
   （2）如果序列依赖过去最近的q个历史预测误差值，称阶数为q，记为==MA(q)==模型。

3. **自回归滑动平均模型ARMA**

###### 2、非平稳时间序列分析

（1）求和自回归移动平均模型ARIMA（Auto regressive integrated moving average），简记为式​(1)
$$
ARIMA\left( {{\rm{p,d,q}}} \right)
$$
其中，p为自回归项数；q为移动平均项数；d为时间序列平稳时做的差分次数。
		ARIMA模型的实质是差分运算与ARMA模型的组合。
（2）==I(d)==含义是模型对时间序列进行了差分。因为时间序列分析要求平稳性，不平稳的序列需要通过一定手段转化为平稳序列，一般采用的方法是差分。
（3）d表示差分的阶数。

- t时刻的值减去(t-1)时刻的值，得到新的时间序列称为==1阶差分序列==；
- 1阶差分序列的1阶差分序列称为==2阶差分序列==，以此类推；
- 特殊的差分——季节性差分S，即一些时间序列反应出一定的周期T，让t时刻的值减去(t-T)时刻的值得到==季节性差分序列==。

（2）季节模型
		①简单季节模型：各效应之间是加法关系
		②乘积季节模型——季节性ARIMA模型：各效应之间是乘积关系，模型简记为
$$
ARIMA\left( {{\rm{p,d,q}}} \right){\left( {P,D,Q} \right)_S}
$$

### 时间序列TS分析的基本思路与步骤

#### 时间序列分类

##### **分类一：**

（1）白噪声序列（纯随机性的序列，序列里不存在任何范式或规则，没有预测价值）

（2）平稳非白噪声序列（均值及方差为常数，可用AR、MA、ARMA等模型来拟合）
（3）非平稳序列（转化为平稳序列，再用平稳序列算法进行拟合，如使用差分变换->ARIMA)

##### **分类二：**

（1）单变量TS（ARMA->GARCH[广义自回归条件异方差模型]）
（2）多变量TS（VAR->MGARCH[多变量广义自回归条件异方差模型]）

#### TS分析步骤

**->待分析**
**一、平稳性检验**（单位根检验、自相关图ACF、偏自相关图PACF）
自相关图：
	截尾J（某一阶后系数都变为0）
	拖尾T（衰减趋势但不会达到0）
e.g.大绝对值->0->大绝对值，如sin、cos：不存在截尾、拖尾，就是一种单调序列，即数据不平稳，不是一个平稳序列

|      | ACF  | PACF |       |
| ---- | ---- | ---- | ----- |
| 1    | J    | T    | MA    |
| 2    | T    | J    | AR    |
| 3    | T    | T    | ARMAN |

非平稳——差分变换——平稳
**Y->平稳**
**二、白噪声检验**
是——停止，无分析价值
非——计算ACF、PACF
**三、模型识别**
e.g. SAS系统识别
MTY=2，最小信息准则，最接近2的模型[Minimum Table Yield]
**四、参数估计**
**五、模型检验**
**六、模型优化**
**七、模型预测**

## 基于机器学习模型的时间序列预测

### 传统机器学习模型与深度学习模型的对比

​		时间序列数据在各领域中无处不在，如物联网传感器的测量结果、每小时的销售额业绩、金融领域的股票价格等等。
​		时间序列预测就是运用历史的多维数据进行统计分析，推测出事物的发展趋势，在预测性维护、智慧能耗分析、价格销量预估等场景有极大的应用价值。
​		随着人工智能技术的快速发展，相较于传统模型，采用机器学习模型来解决时序预测问题成为主流方式，机器学习具有拟合能力较强、解释性强等优势，但存在需要人工设计特征，灵活性不足等问题。
​		随着企业面临的复杂时间序列预测场景越来越大，复杂时序预测场景下的长时序、多变量、非平稳等特性严重影响模型预测的精度。这要求模型具有较强的解决长距离依赖问题的能力，可以捕捉和利用多变量之间的动态相关性。传统的机器学习模型无法有效地解决这些问题，而深度学习的发展恰好为时序分析预测提供了新路径。
​		深度学习天然契合时序问题，具有拟合能力强、表达能力强、灵活度高等特点，能够适应复杂的应用场景，具有更高的效果潜力。

### ARIMA类模型与深度学习模型的对比

​		早期的时间序列预测主要模型是诸如ARIMA这样的单序列线性模型。这种模型对每个序列分别进行拟合。在ARIMA的基础上，又提出了引入非线性、引入外部特征等的优化。然而，ARIMA类模型在处理大规模时间序列时效率较低，并且由于每个序列分别独立拟合，无法共享不同序列存在的相似规律。
​		深度学习模型在NLP、CV等领域取得成功应用后，也被逐渐引入到解决时间序列预测问题中。通过不同序列共享一个深度学习模型，让模型能从多个序列中学到知识，并且提升了在大规模数据上的求解效率。
​		深度学习模型在时间序列预测问题中的应用，主要包括RNN、CNN、Transformer、Nbeats等4种类型模型。